# 抖店财务应用（闪电帐PRO）宝塔服务器部署指南

> **文档版本**：V1.0  
> **更新日期**：2026年1月11日  
> **适用项目**：doudian-finance-prototype  
> **作者**：Manus AI

---

## 一、项目技术栈概述

本项目采用现代化的全栈技术架构，部署前需要了解以下技术组件：

| 组件 | 技术选型 | 版本要求 | 说明 |
|------|----------|----------|------|
| 前端框架 | React + Vite | React 19.x, Vite 7.x | 单页应用，构建后为静态文件 |
| 后端框架 | Express + tRPC | Express 4.x | Node.js 服务端 |
| 数据库 | MySQL | 5.7+ 或 8.0+ | 存储业务数据 |
| 包管理器 | pnpm | 10.x | 依赖安装和项目构建 |
| 运行时 | Node.js | 18.x 或 20.x | 服务端运行环境 |

---

## 二、服务器环境要求

### 2.1 硬件配置建议

| 配置项 | 最低配置 | 推荐配置 |
|--------|----------|----------|
| CPU | 1核 | 2核及以上 |
| 内存 | 2GB | 4GB及以上 |
| 硬盘 | 40GB SSD | 100GB SSD |
| 带宽 | 3Mbps | 5Mbps及以上 |

### 2.2 操作系统

推荐使用 **CentOS 7.x / 8.x** 或 **Ubuntu 20.04 / 22.04 LTS**，本文档以 CentOS 7.x 为例进行说明。

---

## 三、宝塔面板安装

如果服务器尚未安装宝塔面板，请先执行以下命令安装：

### 3.1 CentOS 安装命令

```bash
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh ed8484bec
```

### 3.2 Ubuntu/Debian 安装命令

```bash
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh ed8484bec
```

安装完成后，记录面板访问地址、用户名和密码。

---

## 四、宝塔面板环境配置

### 4.1 安装必要软件

登录宝塔面板后，进入 **软件商店**，安装以下软件：

| 软件名称 | 版本建议 | 用途 |
|----------|----------|------|
| Nginx | 1.24+ | Web服务器/反向代理 |
| MySQL | 5.7 或 8.0 | 数据库服务 |
| PM2管理器 | 最新版 | Node.js进程管理 |

### 4.2 安装 Node.js

在宝塔面板中：

1. 进入 **软件商店** → 搜索 **Node.js版本管理器** → 安装
2. 安装完成后，点击 **设置** → 选择安装 **Node.js 20.x LTS** 版本
3. 将 Node.js 20.x 设置为 **命令行版本**

### 4.3 安装 pnpm

通过 SSH 连接服务器，执行以下命令安装 pnpm：

```bash
npm install -g pnpm@10
```

验证安装：

```bash
pnpm --version
# 应输出 10.x.x
```

---

## 五、项目部署步骤

### 5.1 创建网站目录

在宝塔面板中：

1. 进入 **网站** → **添加站点**
2. 填写域名（如 `finance.yourdomain.com`）
3. 选择 **纯静态** 或 **PHP**（后续会修改配置）
4. 记录网站根目录路径，通常为 `/www/wwwroot/finance.yourdomain.com`

### 5.2 上传项目代码

**方式一：通过宝塔文件管理器上传**

1. 将本地项目打包为 zip 文件
2. 进入 **文件** → 导航到网站根目录
3. 上传 zip 文件并解压

**方式二：通过 Git 拉取（推荐）**

```bash
cd /www/wwwroot/finance.yourdomain.com
git clone https://your-git-repo-url.git .
```

### 5.3 安装项目依赖

通过 SSH 进入项目目录：

```bash
cd /www/wwwroot/finance.yourdomain.com
pnpm install
```

### 5.4 配置环境变量

在项目根目录创建 `.env` 文件：

```bash
nano .env
```

添加以下环境变量（根据实际情况修改）：

```env
# 数据库配置
DATABASE_URL=mysql://用户名:密码@127.0.0.1:3306/数据库名

# JWT密钥（请生成随机字符串）
JWT_SECRET=your-random-jwt-secret-key-at-least-32-chars

# 应用配置
NODE_ENV=production
PORT=3000

# OAuth配置（如需要）
VITE_APP_ID=your-app-id
OAUTH_SERVER_URL=https://your-oauth-server.com
VITE_OAUTH_PORTAL_URL=https://your-oauth-portal.com

# 应用信息
VITE_APP_TITLE=闪电帐PRO
VITE_APP_LOGO=/logo.svg
```

### 5.5 创建数据库

在宝塔面板中：

1. 进入 **数据库** → **添加数据库**
2. 填写数据库名称（如 `doudian_finance`）
3. 设置用户名和密码
4. 记录这些信息，更新到 `.env` 文件的 `DATABASE_URL` 中

### 5.6 初始化数据库

```bash
cd /www/wwwroot/finance.yourdomain.com
pnpm db:push
```

### 5.7 构建项目

```bash
pnpm build
```

构建成功后，会生成以下文件：
- `dist/client/` - 前端静态文件
- `dist/index.js` - 后端服务入口

---

## 六、配置 PM2 进程管理

### 6.1 创建 PM2 配置文件

在项目根目录创建 `ecosystem.config.cjs` 文件：

```javascript
module.exports = {
  apps: [{
    name: 'doudian-finance',
    script: 'dist/index.js',
    cwd: '/www/wwwroot/finance.yourdomain.com',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
};
```

### 6.2 启动应用

```bash
pm2 start ecosystem.config.cjs
```

### 6.3 设置开机自启

```bash
pm2 save
pm2 startup
```

### 6.4 常用 PM2 命令

| 命令 | 说明 |
|------|------|
| `pm2 list` | 查看所有进程 |
| `pm2 logs doudian-finance` | 查看日志 |
| `pm2 restart doudian-finance` | 重启应用 |
| `pm2 stop doudian-finance` | 停止应用 |
| `pm2 delete doudian-finance` | 删除应用 |

---

## 七、配置 Nginx 反向代理

### 7.1 修改网站配置

在宝塔面板中：

1. 进入 **网站** → 点击对应网站的 **设置**
2. 选择 **配置文件**
3. 将配置修改为以下内容：

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name finance.yourdomain.com;
    
    # 日志配置
    access_log /www/wwwlogs/finance.yourdomain.com.log;
    error_log /www/wwwlogs/finance.yourdomain.com.error.log;
    
    # 静态文件目录
    root /www/wwwroot/finance.yourdomain.com/dist/client;
    index index.html;
    
    # API 反向代理
    location /api/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
    
    # 前端路由支持（SPA）
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
    }
}
```

### 7.2 配置 SSL 证书（推荐）

在宝塔面板中：

1. 进入 **网站** → 点击对应网站的 **设置**
2. 选择 **SSL** → **Let's Encrypt**
3. 勾选域名，点击 **申请**
4. 开启 **强制HTTPS**

---

## 八、部署验证

### 8.1 检查服务状态

```bash
# 检查 PM2 进程
pm2 list

# 检查端口监听
netstat -tlnp | grep 3000

# 检查 Nginx 状态
systemctl status nginx
```

### 8.2 访问测试

1. 打开浏览器，访问 `https://finance.yourdomain.com`
2. 检查页面是否正常加载
3. 检查左侧导航栏是否可以正常切换
4. 检查浏览器控制台是否有报错

### 8.3 常见问题排查

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 502 Bad Gateway | Node.js 服务未启动 | 执行 `pm2 start ecosystem.config.cjs` |
| 页面空白 | 前端路由配置错误 | 检查 Nginx 的 `try_files` 配置 |
| API 请求失败 | 反向代理配置错误 | 检查 Nginx 的 `/api/` 代理配置 |
| 数据库连接失败 | DATABASE_URL 配置错误 | 检查 `.env` 文件中的数据库连接字符串 |

---

## 九、日常维护

### 9.1 更新部署

当有代码更新时，执行以下步骤：

```bash
cd /www/wwwroot/finance.yourdomain.com

# 拉取最新代码（如使用 Git）
git pull origin main

# 安装依赖（如有新增）
pnpm install

# 重新构建
pnpm build

# 重启服务
pm2 restart doudian-finance
```

### 9.2 日志查看

```bash
# 查看应用日志
pm2 logs doudian-finance

# 查看 Nginx 访问日志
tail -f /www/wwwlogs/finance.yourdomain.com.log

# 查看 Nginx 错误日志
tail -f /www/wwwlogs/finance.yourdomain.com.error.log
```

### 9.3 数据库备份

在宝塔面板中：

1. 进入 **数据库** → 找到对应数据库
2. 点击 **备份** 进行手动备份
3. 或设置 **计划任务** 进行自动定时备份

---

## 十、安全建议

1. **修改默认端口**：将 SSH 端口从 22 改为其他端口
2. **配置防火墙**：只开放 80、443 端口，关闭 3000 端口的外部访问
3. **定期更新**：保持系统和软件包的更新
4. **数据库安全**：
   - 禁止 root 远程登录
   - 使用强密码
   - 定期备份
5. **SSL 证书**：始终使用 HTTPS 访问

---

## 附录：快速部署脚本

将以下脚本保存为 `deploy.sh`，可实现一键部署：

```bash
#!/bin/bash

# 抖店财务应用部署脚本
# 使用方法: bash deploy.sh

set -e

echo "========== 开始部署 =========="

# 进入项目目录
cd /www/wwwroot/finance.yourdomain.com

# 拉取最新代码
echo ">>> 拉取最新代码..."
git pull origin main

# 安装依赖
echo ">>> 安装依赖..."
pnpm install

# 构建项目
echo ">>> 构建项目..."
pnpm build

# 数据库迁移
echo ">>> 数据库迁移..."
pnpm db:push

# 重启服务
echo ">>> 重启服务..."
pm2 restart doudian-finance || pm2 start ecosystem.config.cjs

echo "========== 部署完成 =========="
echo "请访问 https://finance.yourdomain.com 验证"
```

---

**文档结束**

如有问题，请检查各组件的日志文件进行排查，或联系技术支持。
