<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.iocoder.yudao.module.finance.dal.mysql.OrderMapper">

    <resultMap id="BaseResultMap" type="cn.iocoder.yudao.module.finance.dal.dataobject.OrderDO">
        <id column="id" property="id"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="shop_id" property="shopId"/>
        <result column="order_no" property="orderNo"/>
        <result column="product_title" property="productTitle"/>
        <result column="quantity" property="quantity"/>
        <result column="unit_price" property="unitPrice"/>
        <result column="pay_amount" property="payAmount"/>
        <result column="status" property="status"/>
        <result column="receiver_name" property="receiverName"/>
        <result column="receiver_address" property="receiverAddress"/>
        <result column="receiver_phone" property="receiverPhone"/>
        <result column="order_create_time" property="orderCreateTime"/>
        <result column="order_update_time" property="orderUpdateTime"/>
        <result column="platform" property="platform"/>
        <result column="platform_order_id" property="platformOrderId"/>
        <result column="remark" property="remark"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="del_flag" property="delFlag"/>
    </resultMap>

    <!-- 通用查询列 -->
    <sql id="Base_Column_List">
        id, tenant_id, shop_id, order_no, product_title, quantity, unit_price, pay_amount,
        status, receiver_name, receiver_address, receiver_phone, order_create_time,
        order_update_time, platform, platform_order_id, remark, create_time, update_time,
        create_by, update_by, del_flag
    </sql>

    <!-- 按订单号查询 -->
    <select id="selectByOrderNo" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_orders
        WHERE order_no = #{orderNo} AND del_flag = 0
        LIMIT 1
    </select>

    <!-- 按平台订单ID查询 -->
    <select id="selectByPlatformOrderId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_orders
        WHERE platform_order_id = #{platformOrderId} AND platform = #{platform} AND del_flag = 0
        LIMIT 1
    </select>

    <!-- 查询店铺订单统计 -->
    <select id="selectOrderStats" resultType="java.util.Map">
        SELECT
            COUNT(*) as total_count,
            SUM(CASE WHEN status = 'paid' THEN 1 ELSE 0 END) as paid_count,
            SUM(CASE WHEN status = 'shipped' THEN 1 ELSE 0 END) as shipped_count,
            SUM(CASE WHEN status = 'completed' THEN 1 ELSE 0 END) as completed_count,
            SUM(pay_amount) as total_amount,
            SUM(CASE WHEN status = 'paid' THEN pay_amount ELSE 0 END) as paid_amount
        FROM finance_orders
        WHERE shop_id = #{shopId} AND del_flag = 0
        <if test="startTime != null">
            AND create_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND create_time &lt;= #{endTime}
        </if>
    </select>

    <!-- 查询订单列表（带统计） -->
    <select id="selectOrderList" resultType="java.util.Map">
        SELECT
            id, order_no, product_title, quantity, unit_price, pay_amount, status,
            platform, create_time
        FROM finance_orders
        WHERE shop_id = #{shopId} AND del_flag = 0
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="platform != null and platform != ''">
            AND platform = #{platform}
        </if>
        <if test="startTime != null">
            AND create_time >= #{startTime}
        </if>
        <if test="endTime != null">
            AND create_time &lt;= #{endTime}
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

</mapper>
