<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.iocoder.flash.module.finance.dal.mysql.ReconciliationExceptionMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="cn.iocoder.flash.module.finance.dal.dataobject.ReconciliationExceptionDO">
        <id column="id" property="id"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="shop_id" property="shopId"/>
        <result column="reconciliation_id" property="reconciliationId"/>
        <result column="reconciliation_no" property="reconciliationNo"/>
        <result column="exception_type" property="exceptionType"/>
        <result column="exception_level" property="exceptionLevel"/>
        <result column="order_no" property="orderNo"/>
        <result column="order_id" property="orderId"/>
        <result column="order_amount" property="orderAmount"/>
        <result column="platform_amount" property="platformAmount"/>
        <result column="system_amount" property="systemAmount"/>
        <result column="diff_amount" property="diffAmount"/>
        <result column="exception_desc" property="exceptionDesc"/>
        <result column="exception_data" property="exceptionData"/>
        <result column="status" property="status"/>
        <result column="handle_result" property="handleResult"/>
        <result column="handle_remark" property="handleRemark"/>
        <result column="handle_time" property="handleTime"/>
        <result column="handler" property="handler"/>
        <result column="creator" property="creator"/>
        <result column="create_time" property="createTime"/>
        <result column="updater" property="updater"/>
        <result column="update_time" property="updateTime"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, tenant_id, shop_id, reconciliation_id, reconciliation_no, exception_type,
        exception_level, order_no, order_id, order_amount, platform_amount, system_amount,
        diff_amount, exception_desc, exception_data, status, handle_result, handle_remark,
        handle_time, handler, creator, create_time, updater, update_time, deleted
    </sql>

    <!-- 根据对账ID查询异常列表 -->
    <select id="selectByReconciliationId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_reconciliation_exception
        WHERE reconciliation_id = #{reconciliationId} AND deleted = 0
        ORDER BY exception_level DESC, create_time ASC
    </select>

    <!-- 分页查询 -->
    <select id="selectPage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_reconciliation_exception
        WHERE deleted = 0
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        <if test="shopId != null">
            AND shop_id = #{shopId}
        </if>
        <if test="reconciliationId != null">
            AND reconciliation_id = #{reconciliationId}
        </if>
        <if test="exceptionType != null and exceptionType != ''">
            AND exception_type = #{exceptionType}
        </if>
        <if test="exceptionLevel != null and exceptionLevel != ''">
            AND exception_level = #{exceptionLevel}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        <if test="orderNo != null and orderNo != ''">
            AND order_no LIKE CONCAT('%', #{orderNo}, '%')
        </if>
        ORDER BY exception_level DESC, create_time DESC
    </select>

    <!-- 查询未处理的异常 -->
    <select id="selectUnhandled" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_reconciliation_exception
        WHERE deleted = 0 AND status = 0
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        <if test="shopId != null">
            AND shop_id = #{shopId}
        </if>
        ORDER BY 
            CASE exception_level 
                WHEN 'CRITICAL' THEN 1 
                WHEN 'HIGH' THEN 2 
                WHEN 'NORMAL' THEN 3 
                WHEN 'LOW' THEN 4 
            END,
            create_time ASC
    </select>

    <!-- 统计异常数量 -->
    <select id="countByType" resultType="java.util.Map">
        SELECT 
            exception_type,
            COUNT(*) as total,
            SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) as unhandled,
            SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) as handling,
            SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) as handled,
            SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END) as ignored,
            SUM(ABS(diff_amount)) as total_diff_amount
        FROM finance_reconciliation_exception
        WHERE deleted = 0
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        <if test="shopId != null">
            AND shop_id = #{shopId}
        </if>
        <if test="reconciliationId != null">
            AND reconciliation_id = #{reconciliationId}
        </if>
        GROUP BY exception_type
    </select>

    <!-- 统计异常金额 -->
    <select id="sumDiffAmount" resultType="java.util.Map">
        SELECT 
            SUM(CASE WHEN diff_amount > 0 THEN diff_amount ELSE 0 END) as positive_diff,
            SUM(CASE WHEN diff_amount &lt; 0 THEN ABS(diff_amount) ELSE 0 END) as negative_diff,
            SUM(ABS(diff_amount)) as total_diff,
            COUNT(*) as exception_count
        FROM finance_reconciliation_exception
        WHERE deleted = 0 AND status = 0
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        <if test="shopId != null">
            AND shop_id = #{shopId}
        </if>
    </select>

    <!-- 更新处理状态 -->
    <update id="updateHandleStatus">
        UPDATE finance_reconciliation_exception
        SET status = #{status},
            handle_result = #{handleResult},
            handle_remark = #{handleRemark},
            handle_time = NOW(),
            handler = #{handler},
            updater = #{updater},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 批量更新处理状态 -->
    <update id="batchUpdateHandleStatus">
        UPDATE finance_reconciliation_exception
        SET status = #{status},
            handle_result = #{handleResult},
            handle_time = NOW(),
            handler = #{handler},
            updater = #{updater},
            update_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND deleted = 0
    </update>

    <!-- 批量插入 -->
    <insert id="batchInsert">
        INSERT INTO finance_reconciliation_exception (
            tenant_id, shop_id, reconciliation_id, reconciliation_no, exception_type,
            exception_level, order_no, order_id, order_amount, platform_amount,
            system_amount, diff_amount, exception_desc, exception_data, status,
            creator, create_time
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.tenantId}, #{item.shopId}, #{item.reconciliationId}, #{item.reconciliationNo},
                #{item.exceptionType}, #{item.exceptionLevel}, #{item.orderNo}, #{item.orderId},
                #{item.orderAmount}, #{item.platformAmount}, #{item.systemAmount}, #{item.diffAmount},
                #{item.exceptionDesc}, #{item.exceptionData}, 0, #{item.creator}, NOW()
            )
        </foreach>
    </insert>

</mapper>
