<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.flashsaas.module.finance.dal.mysql.DoudianAuthTokenMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="cn.flashsaas.module.finance.dal.dataobject.DoudianAuthTokenDO">
        <id column="id" property="id"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="shop_id" property="shopId"/>
        <result column="shop_name" property="shopName"/>
        <result column="access_token" property="accessToken"/>
        <result column="refresh_token" property="refreshToken"/>
        <result column="expires_in" property="expiresIn"/>
        <result column="token_type" property="tokenType"/>
        <result column="scope" property="scope"/>
        <result column="auth_status" property="authStatus"/>
        <result column="auth_time" property="authTime"/>
        <result column="expire_time" property="expireTime"/>
        <result column="last_refresh_time" property="lastRefreshTime"/>
        <result column="creator" property="creator"/>
        <result column="create_time" property="createTime"/>
        <result column="updater" property="updater"/>
        <result column="update_time" property="updateTime"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, tenant_id, shop_id, shop_name, access_token, refresh_token, expires_in,
        token_type, scope, auth_status, auth_time, expire_time, last_refresh_time,
        creator, create_time, updater, update_time, deleted
    </sql>

    <!-- 根据店铺ID查询Token -->
    <select id="selectByShopId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_doudian_auth_token
        WHERE shop_id = #{shopId} AND deleted = 0
    </select>

    <!-- 查询即将过期的Token列表 -->
    <select id="selectExpiringSoon" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_doudian_auth_token
        WHERE deleted = 0
          AND auth_status = 1
          AND expire_time BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL #{hours} HOUR)
        ORDER BY expire_time ASC
    </select>

    <!-- 查询已过期的Token列表 -->
    <select id="selectExpired" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_doudian_auth_token
        WHERE deleted = 0
          AND auth_status = 1
          AND expire_time &lt; NOW()
    </select>

    <!-- 按租户统计授权状态 -->
    <select id="countByTenantAndStatus" resultType="java.util.Map">
        SELECT 
            auth_status,
            COUNT(*) as count
        FROM finance_doudian_auth_token
        WHERE tenant_id = #{tenantId} AND deleted = 0
        GROUP BY auth_status
    </select>

    <!-- 更新Token -->
    <update id="updateToken">
        UPDATE finance_doudian_auth_token
        SET access_token = #{accessToken},
            refresh_token = #{refreshToken},
            expires_in = #{expiresIn},
            expire_time = #{expireTime},
            last_refresh_time = NOW(),
            updater = #{updater},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 更新授权状态 -->
    <update id="updateAuthStatus">
        UPDATE finance_doudian_auth_token
        SET auth_status = #{authStatus},
            updater = #{updater},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 批量更新过期状态 -->
    <update id="batchUpdateExpiredStatus">
        UPDATE finance_doudian_auth_token
        SET auth_status = 2,
            update_time = NOW()
        WHERE deleted = 0
          AND auth_status = 1
          AND expire_time &lt; NOW()
    </update>

</mapper>
