<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.flashsaas.module.finance.dal.mysql.ProductCostMapper">

    <resultMap id="BaseResultMap" type="cn.flashsaas.module.finance.dal.dataobject.ProductCostDO">
        <id column="id" property="id"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="shop_id" property="shopId"/>
        <result column="product_id" property="productId"/>
        <result column="product_name" property="productName"/>
        <result column="sku_id" property="skuId"/>
        <result column="cost" property="cost"/>
        <result column="sale_price" property="salePrice"/>
        <result column="stock" property="stock"/>
        <result column="cost_method" property="costMethod"/>
        <result column="cost_update_time" property="costUpdateTime"/>
        <result column="platform" property="platform"/>
        <result column="platform_product_id" property="platformProductId"/>
        <result column="remark" property="remark"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="del_flag" property="delFlag"/>
    </resultMap>

    <!-- 通用查询列 -->
    <sql id="Base_Column_List">
        id, tenant_id, shop_id, product_id, product_name, sku_id, cost, sale_price,
        stock, cost_method, cost_update_time, platform, platform_product_id, remark,
        create_time, update_time, create_by, update_by, del_flag
    </sql>

    <!-- 按商品ID和SKU查询 -->
    <select id="selectByProductAndSku" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_product_cost
        WHERE shop_id = #{shopId}
        AND product_id = #{productId}
        <if test="skuId != null and skuId != ''">
            AND sku_id = #{skuId}
        </if>
        AND del_flag = 0
        LIMIT 1
    </select>

    <!-- 按平台商品ID查询 -->
    <select id="selectByPlatformProductId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_product_cost
        WHERE platform_product_id = #{platformProductId}
        AND platform = #{platform}
        AND shop_id = #{shopId}
        AND del_flag = 0
        LIMIT 1
    </select>

    <!-- 查询商品成本统计 -->
    <select id="selectProductCostStats" resultType="java.util.Map">
        SELECT
            COUNT(*) as total_product,
            SUM(stock) as total_stock,
            SUM(cost * stock) as total_cost_value,
            SUM(sale_price * stock) as total_sale_value,
            AVG(cost) as avg_cost,
            AVG(sale_price) as avg_sale_price
        FROM finance_product_cost
        WHERE shop_id = #{shopId} AND del_flag = 0
    </select>

    <!-- 查询低库存商品 -->
    <select id="selectLowStockProducts" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_product_cost
        WHERE shop_id = #{shopId}
        AND stock &lt;= #{threshold}
        AND del_flag = 0
        ORDER BY stock ASC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 查询需要更新成本的商品 -->
    <select id="selectNeedUpdateCost" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_product_cost
        WHERE shop_id = #{shopId}
        AND (cost_update_time IS NULL OR cost_update_time &lt; #{updateBefore})
        AND del_flag = 0
        ORDER BY cost_update_time ASC
        LIMIT #{offset}, #{limit}
    </select>

</mapper>
