<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.flashsaas.module.finance.dal.mysql.ChannelMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="cn.flashsaas.module.finance.dal.dataobject.ChannelDO">
        <id column="id" property="id"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="channel_code" property="channelCode"/>
        <result column="channel_name" property="channelName"/>
        <result column="channel_type" property="channelType"/>
        <result column="account_name" property="accountName"/>
        <result column="account_no" property="accountNo"/>
        <result column="bank_name" property="bankName"/>
        <result column="bank_branch" property="bankBranch"/>
        <result column="initial_balance" property="initialBalance"/>
        <result column="current_balance" property="currentBalance"/>
        <result column="frozen_amount" property="frozenAmount"/>
        <result column="available_balance" property="availableBalance"/>
        <result column="currency" property="currency"/>
        <result column="status" property="status"/>
        <result column="is_default" property="isDefault"/>
        <result column="sort" property="sort"/>
        <result column="remark" property="remark"/>
        <result column="last_sync_time" property="lastSyncTime"/>
        <result column="creator" property="creator"/>
        <result column="create_time" property="createTime"/>
        <result column="updater" property="updater"/>
        <result column="update_time" property="updateTime"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, tenant_id, channel_code, channel_name, channel_type, account_name, account_no,
        bank_name, bank_branch, initial_balance, current_balance, frozen_amount, available_balance,
        currency, status, is_default, sort, remark, last_sync_time,
        creator, create_time, updater, update_time, deleted
    </sql>

    <!-- 根据渠道编码查询 -->
    <select id="selectByChannelCode" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_channel
        WHERE channel_code = #{channelCode} AND tenant_id = #{tenantId} AND deleted = 0
    </select>

    <!-- 查询默认渠道 -->
    <select id="selectDefault" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_channel
        WHERE tenant_id = #{tenantId} AND is_default = 1 AND deleted = 0
        LIMIT 1
    </select>

    <!-- 分页查询 -->
    <select id="selectPage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_channel
        WHERE deleted = 0
        <if test="tenantId != null">
            AND tenant_id = #{tenantId}
        </if>
        <if test="channelType != null and channelType != ''">
            AND channel_type = #{channelType}
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        <if test="channelName != null and channelName != ''">
            AND channel_name LIKE CONCAT('%', #{channelName}, '%')
        </if>
        ORDER BY is_default DESC, sort ASC, create_time DESC
    </select>

    <!-- 查询启用的渠道列表 -->
    <select id="selectEnabledList" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM finance_channel
        WHERE tenant_id = #{tenantId} AND status = 1 AND deleted = 0
        ORDER BY is_default DESC, sort ASC
    </select>

    <!-- 统计渠道余额 -->
    <select id="sumBalance" resultType="java.util.Map">
        SELECT 
            COUNT(*) as channel_count,
            SUM(current_balance) as total_balance,
            SUM(frozen_amount) as total_frozen,
            SUM(available_balance) as total_available
        FROM finance_channel
        WHERE tenant_id = #{tenantId} AND status = 1 AND deleted = 0
    </select>

    <!-- 按类型统计余额 -->
    <select id="sumBalanceByType" resultType="java.util.Map">
        SELECT 
            channel_type,
            COUNT(*) as channel_count,
            SUM(current_balance) as total_balance,
            SUM(available_balance) as available_balance
        FROM finance_channel
        WHERE tenant_id = #{tenantId} AND status = 1 AND deleted = 0
        GROUP BY channel_type
    </select>

    <!-- 更新余额 -->
    <update id="updateBalance">
        UPDATE finance_channel
        SET current_balance = #{currentBalance},
            available_balance = current_balance - frozen_amount,
            updater = #{updater},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 增加余额 -->
    <update id="increaseBalance">
        UPDATE finance_channel
        SET current_balance = current_balance + #{amount},
            available_balance = current_balance + #{amount} - frozen_amount,
            updater = #{updater},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 减少余额 -->
    <update id="decreaseBalance">
        UPDATE finance_channel
        SET current_balance = current_balance - #{amount},
            available_balance = current_balance - #{amount} - frozen_amount,
            updater = #{updater},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
          AND available_balance &gt;= #{amount}
    </update>

    <!-- 冻结金额 -->
    <update id="freezeAmount">
        UPDATE finance_channel
        SET frozen_amount = frozen_amount + #{amount},
            available_balance = current_balance - frozen_amount - #{amount},
            updater = #{updater},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
          AND available_balance &gt;= #{amount}
    </update>

    <!-- 解冻金额 -->
    <update id="unfreezeAmount">
        UPDATE finance_channel
        SET frozen_amount = frozen_amount - #{amount},
            available_balance = current_balance - frozen_amount + #{amount},
            updater = #{updater},
            update_time = NOW()
        WHERE id = #{id} AND deleted = 0
          AND frozen_amount &gt;= #{amount}
    </update>

    <!-- 设置默认渠道 -->
    <update id="setDefault">
        UPDATE finance_channel
        SET is_default = CASE WHEN id = #{id} THEN 1 ELSE 0 END,
            updater = #{updater},
            update_time = NOW()
        WHERE tenant_id = #{tenantId} AND deleted = 0
    </update>

</mapper>
